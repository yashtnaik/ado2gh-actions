name: repo-inventory

on:
  workflow_dispatch:
    inputs:
      ado_org:
        description: 'Azure DevOps organization (e.g., yashtnaik). Leave blank to scan all orgs ADO_PAT can access.'
        required: false
        type: string
      minimal:
        description: 'Use --minimal to speed up inventory (fewer columns)'
        required: false
        default: false
        type: boolean
      artifact_name:
        description: 'Artifact base name'
        required: false
        default: 'repo-inventory-csv'
        type: string

permissions:
  contents: read
  actions: write

jobs:
  generate-inventory:
    name: Generate Inventory & Upload repos.csv
    runs-on: windows-latest
    timeout-minutes: 30
    environment: PAT tokens

    steps:
      # No checkout: we do not reference any files from the repository

      - name: Verify GitHub CLI
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          Write-Host "GitHub CLI version:" -ForegroundColor Cyan
          gh --version
          Write-Host "`nAuthentication status:" -ForegroundColor Cyan
          gh auth status

      - name: Install gh-ado2gh extension
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          Write-Host "Installing gh-ado2gh extension..." -ForegroundColor Cyan
          gh extension install github/gh-ado2gh
          Write-Host "`nInstalled extension version:" -ForegroundColor Cyan
          gh ado2gh --version

      - name: Run inventory-report
        id: run_inventory
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          ADO_PAT: ${{ secrets.ADO_PAT }}  # required by inventory-report
        run: |
          $ErrorActionPreference = 'Stop'

          $adoOrg   = "${{ inputs.ado_org }}"
          $minimal  = "${{ inputs.minimal }}"

          $cmd = "gh ado2gh inventory-report"
          if ($adoOrg -and $adoOrg.Trim().Length -gt 0) {
            $cmd += " --ado-org `"$adoOrg`""
          }
          if ($minimal -eq "true") {
            $cmd += " --minimal"
          }

          Write-Host "[INFO] Executing:" -ForegroundColor Cyan
          Write-Host $cmd

          # Run the inventory command (generates multiple CSVs: orgs.csv, teamprojects.csv, repos.csv, pipelines.csv, ...)
          iex $cmd

          # Find repos.csv anywhere under the working directory
          $repoCsv = Get-ChildItem -Path . -Recurse -Filter "repos.csv" | Select-Object -First 1
          if (-not $repoCsv) {
            Write-Error "[ERROR] Could not find repos.csv after inventory-report. Ensure the command completed successfully."
          }

          Write-Host "[INFO] Found repos.csv at: $($repoCsv.FullName)" -ForegroundColor Green

          # Copy to a known location for artifact upload
          Copy-Item -Path $repoCsv.FullName -Destination .\repos.csv -Force

          # Output path for next step
          "repo_csv_path=$((Resolve-Path .\repos.csv).Path)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          # Optional: Preview top 5 rows
          Write-Host "`n=== repos.csv preview (Top 5 rows) ===" -ForegroundColor Cyan
          Import-Csv .\repos.csv | Select-Object -First 5 | Format-Table -AutoSize

      - name: Upload repos.csv artifact (only)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}-${{ github.run_number }}
          path: ${{ steps.run_inventory.outputs.repo_csv_path }}
          retention-days: 30
          if-no-files-found: error

      - name: Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "## Inventory Complete" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "**Command:** gh ado2gh inventory-report ${{ inputs.ado_org && format('--ado-org {0}', inputs.ado_org) || '' }} ${{ inputs.minimal && '--minimal' || '' }}" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "**Artifact:** `${{ inputs.artifact_name }}-${{ github.run_number }}` (contains only \`repos.csv\`)" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "ðŸ“¥ Download **repos.csv** from Artifacts, modify as needed, and use it for migration/validation workflows." >> $env:GITHUB_STEP_SUMMARY
