workflow:name: 1-migration

on:
  workflow_dispatch:
    inputs:
      max_concurrent:
        description: 'Maximum concurrent migrations (1-5)'
        required: false
        default: '3'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
      csv_path:
        description: 'Path to repos CSV file'
        required: false
        default: 'repos.csv'
      trigger_validation:
        description: 'Automatically trigger validation after migration'
        required: false
        default: false
        type: boolean
  workflow_call:
    inputs:
      max_concurrent:
        description: 'Maximum concurrent migrations (1-5)'
        required: false
        default: '3'
        type: string
      csv_path:
        description: 'Path to repos CSV file'
        required: false
        default: 'repos.csv'
        type: string
      trigger_validation:
        description: 'Automatically trigger validation after migration'
        required: false
        default: false
        type: boolean
      
jobs:
  migrate-repositories:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours (GitHub Free/Pro/Team limit)
    # Note: GitHub Enterprise supports up to 24 hours (1,440 minutes)
    # Adjust based on your GitHub plan
    environment: PAT tokens
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup GitHub CLI
        shell: bash
        run: |
          echo -e "\033[36mGitHub CLI Version:\033[0m"
          gh --version
          
          echo -e "\n\033[36mAuthentication Status:\033[0m"
          gh auth status
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: Install ADO2GH Extension
        shell: bash
        run: |
          echo -e "\033[36mInstalling gh-ado2gh extension...\033[0m"
          gh extension install github/gh-ado2gh
          
          echo -e "\n\033[36mVerifying installation:\033[0m"
          gh ado2gh --version
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
      
      - name: Validate CSV File
        shell: bash
        run: |
          csvPath="${{ inputs.csv_path }}"
          
          if [[ ! -f "$csvPath" ]]; then
            echo -e "\033[31m[ERROR] CSV file not found: $csvPath\033[0m"
            exit 1
          fi
          
          total=$(( $(wc -l < "$csvPath") - 1 ))
          echo -e "\033[32m[INFO] Found ${total} repositories to migrate\033[0m"
          
          header="$(head -n1 "$csvPath")"
          required=(org teamproject repo github_org github_repo gh_repo_visibility)
          missing=()
          for c in "${required[@]}"; do
            if [[ ",$header," != *",$c,"* ]]; then
              missing+=("$c")
            fi
          done
          
          if (( ${#missing[@]} > 0 )); then
            echo -e "\033[31m[ERROR] Missing required columns: ${missing[*]}\033[0m"
            exit 1
          fi
          
          echo -e "\033[32m[SUCCESS] CSV validation passed\033[0m"
      
      - name: Run Concurrent Migration
        shell: bash
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          ADO_PAT: ${{ secrets.ADO_PAT }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Execute migration script with parameters
          ./scripts/1_migration.sh \
            -MaxConcurrent "${{ inputs.max_concurrent }}" \
            -CsvPath "${{ inputs.csv_path }}"
      
      - name: Generate Workflow Summary
        if: always()
        shell: bash
        run: |
          # Find the most recent output CSV
          outputCsv="$(ls -1t repo_migration_output-*.csv 2>/dev/null | head -n1 || true)"
          
          if [[ -n "$outputCsv" && -f "$outputCsv" ]]; then
            header="$(head -n1 "$outputCsv")"
            total=$(( $(wc -l < "$outputCsv") - 1 ))
            nf="$(awk -F',' 'NR==1{print NF}' "$outputCsv")"
            status_col=$(( nf - 1 ))
            log_col=$(( nf ))
            
            success=$(awk -F',' -v sc="$status_col" 'NR>1 && $sc=="Success"{c++} END{print c+0}' "$outputCsv")
            failed=$(awk -F',' -v sc="$status_col" 'NR>1 && $sc=="Failure"{c++} END{print c+0}' "$outputCsv")
            pending=$(awk -F',' -v sc="$status_col" 'NR>1 && $sc=="Pending"{c++} END{print c+0}' "$outputCsv")
            
            # Success rate with 2 decimals
            if (( total > 0 )); then
              successRate=$(awk -v s="$success" -v t="$total" 'BEGIN{printf "%.2f", (s/t)*100}')
            else
              successRate="0"
            fi
            
            # Determine positions for repo/github url rendering
            IFS=',' read -r -a hcols <<< "$header"
            function colpos() {
              local name="$1"
              for i in "${!hcols[@]}"; do
                if [[ "${hcols[$i]}" == "$name" ]]; then
                  echo "$i"; return
                fi
              done
              echo "-1"
            }
            repo_col="$(colpos repo)"
            gh_org_col="$(colpos github_org)"
            gh_repo_col="$(colpos github_repo)"
            org_col="$(colpos org)"
            tp_col="$(colpos teamproject)"
            
            # Create summary markdown
            summary=$(cat <<EOF
# ðŸš€ Migration Execution Summary

## ðŸ“Š Overall Statistics
- **Total Repositories**: ${total}
- **Successfully Migrated**: âœ… ${success}
- **Failed Migrations**: âŒ ${failed}
- **Pending/Not Started**: â³ ${pending}
- **Success Rate**: ${successRate}%
- **Concurrent Jobs**: ${{ inputs.max_concurrent }}

## ðŸ“ Artifacts
- All migration logs available in artifacts section below
- Output CSV: \`${outputCsv##*/}\`
EOF
)
            
            # Add failed migrations table if any
            if (( failed > 0 )); then
              summary+="\n## âŒ Failed Migrations\n\n"
              summary+="| Repository | ADO Org | ADO Team Project | GitHub Org | Log File |\n"
              summary+="|------------|---------|------------------|------------|----------|\n"
              awk -F',' -v sc="$status_col" -v rc="$repo_col" -v oc="$org_col" -v tc="$tp_col" -v goc="$gh_org_col" -v lc="$log_col" 'NR>1 && $sc=="Failure"{printf("| %s | %s | %s | %s | %s |\n",$rc,$oc,$tc,$goc,$lc)}' "$outputCsv" >> summary.tmp
              summary+=$(cat summary.tmp)
              rm -f summary.tmp
            fi
            
            # Add successful migrations summary
            if (( success > 0 )); then
              summary+="\n## âœ… Successfully Migrated Repositories\n\n"
              summary+="Total: ${success} repositories migrated successfully\n\n"
              summary+="| Repository | GitHub URL |\n"
              summary+="|------------|------------|\n"
              # Show first 10 successful migrations
              awk -F',' -v sc="$status_col" -v rc="$repo_col" -v goc="$gh_org_col" -v grc="$gh_repo_col" '
                NR>1 && $sc=="Success" {
                  printf("| %s | https://github.com/%s/%s |\n",$rc,$goc,$grc)
                  count++
                  if (count==10) exit
                }' "$outputCsv" >> summary.tmp
              summary+=$(cat summary.tmp)
              rm -f summary.tmp
              
              if (( success > 10 )); then
                summary+="\n*... and $((success - 10)) more*\n"
              }
            fi
            
            # Write to GitHub Actions summary
            printf "%s" "$summary" >> "$GITHUB_STEP_SUMMARY"
            printf "%s\n" "$summary"
          else
            echo -e "\033[33m[WARNING] No output CSV found\033[0m"
          fi
      
      - name: Upload Migration Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-logs-${{ github.run_id }}
          path: migration-*.txt
          retention-days: 90
          if-no-files-found: warn
      
      - name: Upload Output CSV
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-output-csv-${{ github.run_id }}
          path: repo_migration_output-*.csv
          retention-days: 90
          if-no-files-found: error
      
      - name: Check for Failures
        if: always()
        shell: bash
        run: |
          outputCsv="$(ls -1t repo_migration_output-*.csv 2>/dev/null | head -n1 || true)"
          if [[ -n "$outputCsv" && -f "$outputCsv" ]]; then
            nf="$(awk -F',' 'NR==1{print NF}' "$outputCsv")"
            status_col=$(( nf - 1 ))
            failed=$(awk -F',' -v sc="$status_col" 'NR>1 && $sc=="Failure"{c++} END{print c+0}' "$outputCsv")
            if (( failed > 0 )); then
              echo "::warning::${failed} repositories failed to migrate. Check the logs for details."
              # Don't fail the workflow, just warn
            else
              echo "::notice::All migrations completed successfully!"
            fi
          fi
  
  trigger-validation:
    name: Trigger Migration Validation
    needs: migrate-repositories
    if: github.event.inputs.trigger_validation == 'true' || inputs.trigger_validation == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Trigger Validation Workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '2-migration-validation.yml',
              ref: context.ref,
              inputs: {
                csv_path: '${{ inputs.csv_path }}'
              }
            });
            console.log('âœ… Migration validation workflow triggered successfully');
