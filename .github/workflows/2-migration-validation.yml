
name: 2-migration-validation

on:
  workflow_dispatch:
    inputs:
      csv_path:
        description: 'Path to CSV file with repository list'
        required: true
        default: 'repos.csv'
        type: string

permissions:
  contents: read
  actions: write

jobs:
  validate-migrations:
    name: Validate Migrated Repositories
    runs-on: windows-latest
    timeout-minutes: 120
    environment: PAT tokens  # keep if your org requires approval

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Use Windows PowerShell (5.1) so System.Web works for HttpUtility.UrlEncode
      - name: Setup Git & GH CLI
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh --version

          try {
            gh auth status
          } catch {
            Write-Host "Authenticating gh with GH_TOKEN..."
            # PowerShell-native stdin feed (no bash '<<' or '||')
            $token = $env:GH_TOKEN
            $token | gh auth login --with-token
            gh config set git_protocol https
          }

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Validate CSV File exists & columns
        shell: powershell
        run: |
          $csvPath = "${{ inputs.csv_path }}"

          if (-not (Test-Path -LiteralPath $csvPath)) {
            Write-Error "CSV file not found: $csvPath"
            exit 1
          }

          Write-Host "CSV file found: $csvPath"

          $csv = @(Import-Csv -LiteralPath $csvPath)
          if ($csv.Count -eq 0) {
            Write-Error "CSV has no data rows: $csvPath"
            exit 1
          }

          $requiredColumns = @(
            'org','teamproject','repo','url',
            'last-push-date','pipeline-count','compressed-repo-size-in-bytes',
            'most-active-contributor','pr-count','commits-past-year',
            'github_org','github_repo','gh_repo_visibility'
          )

          $firstRow = $csv | Select-Object -First 1
          $csvColumns = $firstRow.PSObject.Properties.Name
          $missing = $requiredColumns | Where-Object { $_ -notin $csvColumns }

          if (@($missing).Count -gt 0) {
            Write-Error "Missing required columns in CSV: $(@($missing) -join ', ')"
            exit 1
          }

          Write-Host "âœ… CSV validation passed"
          Write-Host "Total repositories to validate: $(@($csv).Count)"

      - name: Run Migration Validation (PowerShell 5.1)
        shell: powershell
        env:
          # Make tokens available as env vars used by your script
          GH_PAT:  ${{ secrets.GH_PAT }}
          ADO_PAT: ${{ secrets.ADO_PAT }}
        run: |
          # Your script expects repos.csv at repo root (or pass the input path explicitly)
          Write-Host "Validation in progress... please wait ..."
          # If your file is saved at scripts/2_migration_validation.ps1, call that path:
          .\scripts\2_migration_validation.ps1
          # If you keep the script at the repo root, use:
          # .\2_migration_validation.ps1

      - name: Upload Validation Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results-${{ github.run_number }}
          path: |
            validation-log-*.txt
            validation-*.json
            validation_summary.csv
          retention-days: 30

      - name: Generate Workflow Summary
        if: always()
        shell: powershell
        run: |
          $summary = $env:GITHUB_STEP_SUMMARY
          Add-Content -Path $summary -Value "## Migration Validation Summary"
          Add-Content -Path $summary -Value ""
          Add-Content -Path $summary -Value "**Run Number:** ${{ github.run_number }}"
          Add          Add-Content -Path $summary -Value "**CSV Path:** ${{ inputs.csv_path }}"
          Add-Content -Path $summary -Value ""

          $logFile = Get-ChildItem -Filter "validation-log-*.txt" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($logFile) {
            Add-Content -Path $summary -Value "### Validation Log Preview"
            Add-Content -Path $summary -Value ""
            Add-Content -Path $summary -Value '```'
            Get-Content $logFile.FullName -Tail 50 | ForEach-Object { Add-Content -Path $summary -Value $_ }
            Add-Content -Path $summary -Value '```'
            Add-Content -Path $summary -Value ""
            Add-Content -Path $summary -Value "ðŸ“Š Full validation results available in workflow artifacts"
