
name: 2-migration-validation

on:
  workflow_dispatch:
    inputs:
      csv_path:
        description: 'Path to CSV file with repository list'
        required: true
        default: ''
        type: string

permissions:
  contents: read
  actions: write

jobs:
  validate-migrations:
    name: Validate Migrated Repositories
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Use Windows PowerShell (5.1) so System.Web works for HttpUtility.UrlEncode
      - name: Setup Git & GH CLI
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh --version

          try {
            gh auth status
          } catch {
            Write-Host "Authenticating gh with GH_TOKEN..."
            $token = $env:GH_TOKEN
            $token | gh auth login --with-token
            gh config set git_protocol https
          }

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Prepare CSV for script (ensure it is repos.csv at repo root)
        shell: powershell
        run: |
          $inputPath = "${{ inputs.csv_path }}"
          if (-not (Test-Path -LiteralPath $inputPath)) {
            Write-Error "CSV file not found at input path: $inputPath"
            exit 1
          }

          if ($inputPath -ne "repos.csv") {
            Copy-Item -LiteralPath $inputPath -Destination "repos.csv" -Force
            Write-Host "Copied $inputPath -> repos.csv for the script"
          } else {
            Write-Host "Using repos.csv as-is for the script"
          }

      - name: Run Migration Validation (PowerShell 5.1)
        shell: powershell
        env:
          GH_PAT:  ${{ secrets.GH_PAT }}
          ADO_PAT: ${{ secrets.ADO_PAT }}
        run: |
          Write-Host "Validation in progress... please wait ..."
          # Path to your working script. Adjust if needed.
          .\scripts\2_migration_validation.ps1
          # If your script is at repo root, use:
          # .\2_migration_validation.ps1

      # Build a clean table-only summary with ✅/❌ by parsing the log your script wrote
      - name: Generate Table Summary (tick marks only)
        shell: powershell
        run: |
          $summaryPath = $env:GITHUB_STEP_SUMMARY
          $today = (Get-Date).ToString('yyyyMMdd')
          $logFile = "validation-log-$today.txt"

          if (-not (Test-Path -LiteralPath $logFile)) {
            Write-Warning "Log file not found: $logFile. Skipping summary table."
            exit 0
          }

          $lines = Get-Content -LiteralPath $logFile

          # Collect per-repo status
          $repoSummaries = @()
          $current = $null

          foreach ($line in $lines) {
            # Start of repo block
            if ($line -match '\] Validating migration:\s+(?<repo>.+)$') {
              if ($null -ne $current) {
                # finalize previous if wasn't closed cleanly
                $current.CommitCount = if ($current.AnyCommitMismatch) { '❌ Not Matching' } else { '✅ Matching' }
                $current.LatestSHA   = if ($current.AnyShaMismatch)    { '❌ Not Matching' } else { '✅ Matching' }
                $current.Overall     = if ($current.BranchCount -eq '✅ Matching' -and $current.CommitCount -eq '✅ Matching' -and $current.LatestSHA -eq '✅ Matching') { '✅' } else { '❌' }
                $repoSummaries += $current
              }

              $repoName = $matches['repo'].Trim()
              $current = [ordered]@{
                Repo              = $repoName
                BranchCount       = ''
                CommitCount       = ''
                LatestSHA         = ''
                Overall           = ''
                AnyCommitMismatch = $false
                AnyShaMismatch    = $false
              }
              continue
            }

            if ($null -ne $current) {
              # Branch count status for the repo
              if ($line -match 'Branch Count:.*\|\s*(?<status>✅ Matching|❌ Not Matching)$') {
                $current.BranchCount = $matches['status']
                continue
              }

              # Per-branch commit count line
              if ($line -match "Branch '.*': .*Commits=.*\|\s*GitHub Commits=.*\|\s*(?<status>✅ Matching|❌ Not Matching)$") {
                if ($matches['status'] -eq '❌ Not Matching') { $current.AnyCommitMismatch = $true }
                continue
              }

              # Per-branch latest SHA line
              if ($line -match "Branch '.*': .*SHA=.*\|\s*GitHub SHA=.*\|\s*(?<status>✅ Matching|❌ Not Matching)$") {
                if ($matches['status'] -eq '❌ Not Matching') { $current.AnyShaMismatch = $true }
                continue
              }

              # End of repo block
              if ($line -match '\] Validation complete for\s+(?<repo>.+)$') {
                $current.CommitCount = if ($current.AnyCommitMismatch) { '❌ Not Matching' } else { '✅ Matching' }
                $current.LatestSHA   = if ($current.AnyShaMismatch)    { '❌ Not Matching' } else { '✅ Matching' }
                $current.Overall     = if ($current.BranchCount -eq '✅ Matching' -and $current.CommitCount -eq '✅ Matching' -and $current.LatestSHA -eq '✅ Matching') { '✅' } else { '❌' }
                $repoSummaries += $current
                $current = $null
                continue
              }
            }
          }

          # If file ended without "Validation complete for", finalize the last one
          if ($null -ne $current) {
            $current.CommitCount = if ($current.AnyCommitMismatch) { '❌ Not Matching' } else { '✅ Matching' }
            $current.LatestSHA   = if ($current.AnyShaMismatch)    { '❌ Not Matching' } else { '✅ Matching' }
            $current.Overall     = if ($current.BranchCount -eq '✅ Matching' -and $current.CommitCount -eq '✅ Matching' -and $current.LatestSHA -eq '✅ Matching') { '✅' } else { '❌' }
            $repoSummaries += $current
          }

          # Write Markdown table to job summary
          Add-Content -Path $summaryPath -Value "## Validate Migrated Repositories — Status Table"
          Add-Content -Path $summaryPath -Value ""
          Add-Content -Path $summaryPath -Value "| Repository | Branch Count | Commit Count | Latest SHA | Overall |"
          Add-Content -Path $summaryPath -Value "|---|---|---|---|---|"

          foreach ($row in $repoSummaries) {
            $line = "| $($row.Repo) | $($row.BranchCount) | $($row.CommitCount) | $($row.LatestSHA) | $($row.Overall) |"
            Add-Content -Path $summaryPath -Value $line
          }

          # Optional totals row
          $total   = $repoSummaries.Count
          $allOK   = ($repoSummaries | Where-Object { $_.Overall -eq '✅' }).Count
          $notOK   = ($repoSummaries | Where-Object { $_.Overall -eq '❌' }).Count

          Add-Content -Path $summaryPath -Value ""
          Add-Content -Path $summaryPath -Value "**Totals:** $allOK ✅ / $notOK ❌ (out of $total          Add-Content -Path $summaryPath -Value "**Totals:** $allOK ✅ / $notOK ❌ (out of $total repos)"

      - name: Upload Validation Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results-${{ github.run_number }}
          path: |
            validation-log-*.txt
            validation-*.json
            validation_summary.csv
