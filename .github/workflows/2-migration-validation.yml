name: 2-migration-validation

on:
  workflow_dispatch:
    inputs:
      csv_path:
        description: 'Path to CSV file with repository list'
        required: true
        default: 'repos.csv'
        type: string
      # trigger_mannequins:
      #   description: 'Automatically trigger mannequin validation after migration validation'
      #   required: false
      #   default: false
      #   type: boolean
      # github_org:
      #   description: 'GitHub organization name (required if triggering mannequins)'
      #   required: false
      #   type: string

  # workflow_call:
  #   inputs:
  #     csv_path:
  #       description: 'Path to CSV file with repository list'
  #       required: false
  #       default: 'repos.csv'
  #       type: string
  #     trigger_mannequins:
  #       description: 'Automatically trigger mannequin validation after migration validation'
  #       required: false
  #       default: false
  #       type: boolean
  #     github_org:
  #       description: 'GitHub organization name (required if triggering mannequins)'
  #       required: false
  #       type: string

permissions:
  contents: read
  actions: write

jobs:
  validate-migrations:
    name: Validate Migrated Repositories
    runs-on: windows-latest
    timeout-minutes: 120  # 2 hours for validation
    # environment: PAT tokens  # Requires approval before running

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          # Verify gh CLI is available (pre-installed on GitHub runners)
          gh --version

          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
        shell: pwsh

      - name: Install gh ado2gh extension
        run: |
          Write-Host "Installing gh ado2gh extension..."
          gh extension install github/gh-ado2gh

          Write-Host "Verifying installation..."
          gh ado2gh version
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Validate CSV File
        run: |
          $csvPath = "${{ inputs.csv_path }}"

          if (-not (Test-Path $csvPath)) {
            Write-Error "CSV file not found: $csvPath"
            exit 1
          }

          Write-Host "CSV file found: $csvPath"

          # Validate CSV structure
          $csv = Import-Csv -Path $csvPath
          $requiredColumns = @('org', 'teamproject', 'repo', 'github_org', 'github_repo')

          $csvColumns = $csv[0].PSObject.Properties.Name
          $missingColumns = $requiredColumns | Where-Object { $_ -notin $csvColumns }

          if ($missingColumns.Count -gt 0) {
            Write-Error "Missing required columns in CSV: $($missingColumns -join ', ')"
            exit 1
          }

          Write-Host "âœ… CSV validation passed"
          Write-Host "Total repositories to validate: $($csv.Count)"
        shell: pwsh

      - name: Run Migration Validation
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          ADO_PAT: ${{ secrets.ADO_PAT }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Execute validation script with parameters
          Write-Host "Validation in progress... please wait ..."
          .\scripts\2_migration_validation.ps1 -CsvPath "$env:CSV_PATH" -GhOrg "$env:GH_ORG"
        shell: pwsh

      - name: Upload Validation Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results-${{ github.run_number }}
          path: |
            validation-*.txt
            validation-*.json
          retention-days: 30

      - name: Generate Workflow Summary
        if: always()
        run: |
          Write-Host "## Migration Validation Summary" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "**Run Number:** ${{ github.run_number }}" >> $env:GITHUB_STEP_SUMMARY       
          Write-Host "**CSV Path:** ${{ inputs.csv_path }}" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "" >> $env:GITHUB_STEP_SUMMARY

          # Check for validation log
          $logFile = Get-ChildItem -Filter "validation-log-*.txt" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($logFile) {
            Write-Host "### Validation Log Preview" >> $env:GITHUB_STEP_SUMMARY
            Write-Host "" >> $env:GITHUB_STEP_SUMMARY
            Write-Host '```' >> $env:GITHUB_STEP_SUMMARY
            Get-Content $logFile.FullName -Tail 50 | ForEach-Object {
              $_ >> $env:GITHUB_STEP_SUMMARY
            }
            Write-Host '```' >> $env:GITHUB_STEP_SUMMARY
            Write-Host "" >> $env:GITHUB_STEP_SUMMARY
            Write-Host "ðŸ“Š Full validation results available in workflow artifacts" >> $env:GITHUB_STEP_SUMMARY
          }
        shell: pwsh
  
  # trigger-mannequins-validation:
  #   name: Trigger Mannequins Validation
  #   needs: validate-migrations
  #   if: github.event.inputs.trigger_mannequins == 'true' || inputs.trigger_mannequins == true
  #   runs-on: ubuntu-latest
    
  #   steps:
  #     - name: Trigger Mannequins Validation Workflow
  #       uses: actions/github-script@v7
  #       with:
  #         github-token: ${{ secrets.GH_PAT }}
  #         script: |
  #           const githubOrg = '${{ inputs.github_org }}';
  #           if (!githubOrg) {
  #             core.setFailed('github_org is required when trigger_mannequins is true');
  #             return;
  #           }
            
  #           await github.rest.actions.createWorkflowDispatch({
  #             owner: context.repo.owner,
  #             repo: context.repo.repo,
  #             workflow_id: '3-mannequins-validation.yml',
  #             ref: context.ref,
  #             inputs: {
  #               github_org: githubOrg,
  #               output_file: 'mannequins.csv'
  #             }
  #           });
  #           console.log('âœ… Mannequins validation workflow triggered successfully');
