
name: 2-migration-validation

on:
  workflow_dispatch:
    inputs:
      csv_path:
        description: 'Path to CSV file with repository list'
        required: true
        default: 'repos.csv'
        type: string
      # trigger_mannequins:
      #   description: 'Automatically trigger mannequin validation after migration validation'
      #   required: false
      #   default: false
      #   type: boolean
  #     github_org:
  #       description: 'GitHub organization name (required if triggering mannequins)'
  #       required: false
  #       type: string

  # workflow_call:
  #   inputs:
  #     csv_path:
  #       description: 'Path to CSV file with repository list'
  #       required: false
  #       default: 'repos.csv'
  #       type: string
  #     trigger_mannequins:
  #       description: 'Automatically trigger mannequin validation after migration validation'
  #       required: false
  #       default: false
  #       type: boolean
  #     github_org:
  #       description: 'GitHub organization name (required if triggering mannequins)'
  #       required: false
  #       type: string

permissions:
  contents: read
  actions: write

jobs:
  validate-migrations:
    name: Validate Migrated Repositories
    runs-on: windows-latest
    timeout-minutes: 120  # 2 hours for validation
    environment: PAT tokens  # Requires approval before running

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          # Verify gh CLI is available (pre-installed on GitHub runners)
          gh --version

          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
        shell: pwsh

      - name: Install gh ado2gh extension
        run: |
          Write-Host "Installing gh ado2gh extension..."
          gh extension install github/gh-ado2gh

          Write-Host "Verifying installation..."
          gh ado2gh version
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}

      - name: Validate CSV File
        run: |
          $csvPath = "${{ inputs.csv_path }}"

          if (-not (Test-Path $csvPath)) {
            Write-Error "CSV file not found: $csvPath"
            exit 1
          }

          Write-Host "CSV file found: $csvPath"

          # Validate CSV structure
          $csv = Import-Csv -Path $csvPath
          $requiredColumns = @('org', 'teamproject', 'repo', 'github_org', 'github_repo')

          $csvColumns = $csv[0].PSObject.Properties.Name
          $missingColumns = $requiredColumns | Where-Object { $_ -notin $csvColumns }

          if ($missingColumns.Count -gt 0) {
            Write-Error "Missing required columns in CSV: $($missingColumns -join ', ')"
            exit 1
          }

          Write-Host "✅ CSV validation passed"
          Write-Host "Total repositories to validate: $($csv.Count)"
        shell: pwsh

      - name: Run Migration Validation
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          ADO_PAT: ${{ secrets.ADO_PAT }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Execute validation script with parameters
          .\scripts\2_migration_validation.ps1 -CsvPath "${{ inputs.csv_path }}"
        shell: pwsh

      - name: Upload Validation Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results-${{ github.run_number }}
          path: |
            validation-*.txt
            validation-*.json
          retention-days: 30

      # Table-only summary with ✅/❌, minimal fix applied to totals
      - name: Generate Table Summary (tick marks only, robust)
        shell: pwsh
        run: |
          $summaryPath = $env:GITHUB_STEP_SUMMARY
      
          # Find latest validation log
          $logCandidates = Get-ChildItem -File -Filter "validation-log-*.txt" | Sort-Object LastWriteTime -Descending
          if (@($logCandidates).Count -eq 0) {
            Write-Warning "No validation-log-*.txt found. Skipping summary table."
            exit 0
          }
          $logFile = $logCandidates[0].FullName
          Write-Host "Using log file: $logFile"
      
          # Read UTF-8 to preserve emojis
          $lines = Get-Content -LiteralPath $logFile -Encoding UTF8
      
          function Finalize-Row {
            param([hashtable]$row)
            $commitStatus = if ($row.AnyCommitMismatch) { '❌ Not Matching' } else { '✅ Matching' }
            $shaStatus    = if ($row.AnyShaMismatch)    { '❌ Not Matching' } else { '✅ Matching' }
            $overall      = if (($row.BranchCount -eq '✅ Matching') -and ($commitStatus -eq '✅ Matching') -and ($shaStatus -eq '✅ Matching')) { '✅' } else { '❌' }
            [pscustomobject]@{
              Repository   = $row.Repo
              BranchCount  = $row.BranchCount
              CommitCount  = $commitStatus
              LatestSHA    = $shaStatus
              Overall      = $overall
            }
          }
      
          # Parse the log
          $repoSummaries = New-Object System.Collections.Generic.List[object]
          $current = $null
      
          foreach ($line in $lines) {
            if ($line -match '^\[.+\]\s+Validating migration:\s+(?<repo>.+)$') {
              if ($null -ne $current) { $repoSummaries.Add( (Finalize-Row -row $current) ) }
              $current = @{
                Repo              = $matches['repo'].Trim()
                BranchCount       = ''
                AnyCommitMismatch = $false
                AnyShaMismatch    = $false
              }
              continue
            }
      
            if ($null -eq $current) { continue }
      
            if ($line -match '^\[.+\]\s+Branch Count:.*\|\s+(?<status>✅ Matching|❌ Not Matching)$') {
              $current.BranchCount = $matches['status']; continue
            }
      
            if ($line -match "^\[.+\]\s+Branch '.+?': .*Commits=.*\|\s*GitHub Commits=.*\|\s*(?<status>✅ Matching|❌ Not Matching)$") {
              if ($matches['status'] -eq '❌ Not Matching') { $current.AnyCommitMismatch = $true }
              continue
            }
      
            if ($line -match "^\[.+\]\s+Branch '.+?': .*SHA=.*\|\s*GitHub SHA=.*\|\s*(?<status>✅ Matching|❌ Not Matching)$") {
              if ($matches['status'] -eq '❌ Not Matching') { $current.AnyShaMismatch = $true }
              continue
            }
      
            if ($line -match '^\[.+\]\s+Validation complete for\s+(?<repo>.+)$') {
              $repoSummaries.Add( (Finalize-Row -row $current) ); $current = $null; continue
            }
          }
      
          if ($null -ne $current) { $repoSummaries.Add( (Finalize-Row -row $current) ) }
      
          # Helper to write UTF-8 lines safely
          function Write-Line([string]$text) { $text | Out-File -FilePath $summaryPath -Append -Encoding utf8 }
      
          # Build header/separator using char codes (avoids raw '|' parsing)
          $pipe = [char]124
          $header = "{0} Repository {0} Branch Count {0} Commit Count {0} Latest SHA {0} Overall {0}" -f $pipe
          $separator = [string]::Join('', @("$pipe","---$pipe","---$pipe","---$pipe","---$pipe","---$pipe"))
      
          Write-Line "## Validate Migrated Repositories — Status Table"
          Write-Line ""
          Write-Line $header
          Write-Line $separator
      
          foreach ($row in $repoSummaries) {
            $lineMd = "{0} {1} {0} {2} {0} {3} {0} {4} {0} {5} {0}" -f $pipe, $row.Repository, $row.BranchCount, $row.CommitCount, $row.LatestSHA, $row.Overall
            Write-Line $lineMd
          }
      
          # ✅ Minimal fix: use List[T].Count and materialize arrays for pipeline counts
          $total = $repoSummaries.Count
          $ok    = ( $repoSummaries | Where-Object { $_.Overall -eq '✅' } | ForEach-Object { $_ } ).Count
          $bad   = ( $repoSummaries | Where-Object { $_.Overall -eq '❌' } | ForEach-Object { $_ } ).Count
      
          Write-Line ""
          Write-Line ("**Totals:** {0} ✅ / {1} ❌ (out of {2} repos)" -f $ok, $bad, $total)
