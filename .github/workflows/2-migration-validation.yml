
name: 2-migration-validation

on:
  workflow_dispatch:
    inputs:
      csv_path:
        description: 'Path to CSV file with repository list'
        required: true
        default: 'repos.csv'
        type: string

permissions:
  contents: read
  actions: write

jobs:
  validate-migrations:
    name: Validate Migrated Repositories
    runs-on: windows-latest
    timeout-minutes: 120
    environment: PAT tokens

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Git & GH CLI
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh --version

          try {
            gh auth status
          } catch {
            Write-Host "Authenticating gh with GH_TOKEN..."
            Write-Output $env:GH_TOKEN | gh auth login --with-token
          }

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Validate CSV File
        shell: pwsh
        run: |
          $csvPath = "${{ inputs.csv_path }}"

          if (-not (Test-Path -LiteralPath $csvPath)) {
            Write-Error "CSV file not found: $csvPath"
            exit 1
          }

          Write-Host "CSV file found: $csvPath"

          $csv = Import-Csv -LiteralPath $csvPath
          $requiredColumns = @('org', 'teamproject', 'repo', 'url', 'github_org', 'github_repo')
          $csvColumns = $csv[0].PSObject.Properties.Name
          $missingColumns = $requiredColumns | Where-Object { $_ -notin $csvColumns }

          if ($missingColumns.Count -gt 0) {
            Write-Error "Missing required columns in CSV: $($missingColumns -join ', ')"
            exit 1
          }

          Write-Host "âœ… CSV validation passed"
          Write-Host "Total repositories to validate: $($csv.Count)"

      - name: Derive GH_ORG from CSV and export
        shell: pwsh
        env:
          CSV_PATH: ${{ inputs.csv_path }}
        run: |
          $row = Import-Csv -LiteralPath $env:CSV_PATH | Select-Object -First 1
          if (-not $row) { Write-Error "CSV has no rows."; exit 1 }

          $ghOrgFromCsv = $row.github_org
          if (-not $ghOrgFromCsv) { $ghOrgFromCsv = $row.GH_ORG }

          if (-not $ghOrgFromCsv) {
            Write-Error "CSV is missing 'github_org' (or 'GH_ORG') value in the first row."
            exit 1
          }

          Write-Host "Derived GH_ORG from CSV: $ghOrgFromCsv"
          "GH_ORG=$ghOrgFromCsv"     | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "CSV_PATH=${{ inputs.csv_path }}" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Run Migration Validation
        shell: pwsh
        env:
          GH_PAT:   ${{ secrets.GH_PAT }}
          ADO_PAT:  ${{ secrets.ADO_PAT }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
          # CSV_PATH and GH_ORG persisted via previous step ($GITHUB_ENV)
        run: |
          Write-Host "Validation in progress... please wait ..."
          .\scripts\2_migration_validation.ps1 `
            -CsvPath "$env:CSV_PATH" `
            -GhOrg   "$env:GH_ORG"

      - name: Upload Validation Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results-${{ github.run_number }}
          path: |
            validation-log-*.txt
            validation-results-*.json
            validation_summary.csv
          retention-days: 30

      - name: Generate Workflow Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "## Migration Validation Summary" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "**Run Number:** ${{ github.run_number }}" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "**CSV Path:** ${{ inputs.csv_path }}" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "" >> $env:GITHUB_STEP_SUMMARY

          $logFile = Get-ChildItem -Filter "validation-log-*.txt" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($logFile) {
            Write-Host "### Validation Log Preview" >> $env:GITHUB_STEP_SUMMARY
            Write-Host "" >> $env:GITHUB_STEP_SUMMARY
            Write-Host '```' >> $env:GITHUB_STEP_SUMMARY
            Get-Content $logFile.FullName -Tail 50 | ForEach-Object { $_ >> $env:GITHUB_STEP_SUMMARY }
            Write-Host '```' >> $env:GITHUB_STEP_SUMMARY
            Write-Host "" >> $env:GITHUB_STEP_SUMMARY
            Write-Host "ðŸ“Š Full validation results available in workflow artifacts" >> $env:GITHUB_STEP_SUMMARY
          }
